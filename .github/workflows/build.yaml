name: Build and upload artifacts

on:
  push:
    branches:
    - main
    - develop
    - feat/ci
  pull_request:
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: "3.11.7"
  PIO_BUILD_DIR: .pio/build
  PIO_TEST_ENV: native

jobs:
  test:
    name: Test the project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PlatformIO
        run: pip install platformio

      - name: Test the project
        run: platformio test -e ${{ env.PIO_TEST_ENV }}
  build:
    needs:
      - test
    strategy:
      matrix:
        packages: [
          { name: "Emitter", api_name: "emitter" },
          { name: "Receptor", api_name: "receptor" }
        ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build the ${{ matrix.packages.name }} project
        run: platformio run -e ${{ matrix.packages.api_name }}

      - name: Upload the build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.packages.name }}-build
          path: ${{ env.PIO_BUILD_DIR }}/${{ matrix.packages.api_name }}